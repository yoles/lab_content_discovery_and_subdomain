# TechCorp CTF Lab - Nginx Configuration
# Virtual Hosts for Content Discovery & Subdomain Enumeration

# Main application - techcorp.local
server {
    listen 8080;
    server_name techcorp.local;

    # Logging
    access_log /var/log/nginx/techcorp-access.log;
    error_log /var/log/nginx/techcorp-error.log;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Intentionally vulnerable - serve backup files
    location /backup/ {
        proxy_pass http://127.0.0.1:5000;
    }

    # Intentionally vulnerable - serve .git directory
    location /.git/ {
        proxy_pass http://127.0.0.1:5000;
    }

    # Add revealing headers (intentional vulnerability)
    add_header X-Powered-By "Flask/3.0.0" always;
    add_header Server "nginx/1.24.0" always;
    add_header X-TechCorp-Environment "production" always;
}

# Development subdomain - dev.techcorp.local
server {
    listen 8081;
    server_name dev.techcorp.local;

    # Logging
    access_log /var/log/nginx/dev-access.log;
    error_log /var/log/nginx/dev-error.log;

    location / {
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Debug headers (intentional vulnerability)
    add_header X-Debug-Mode "enabled" always;
    add_header X-Environment "development" always;
    add_header X-Flask-Debug "true" always;
    add_header X-Developer "john.dev@techcorp.local" always;
}

# Staging subdomain - staging.techcorp.local
server {
    listen 8082;
    server_name staging.techcorp.local;

    # Logging
    access_log /var/log/nginx/staging-access.log;
    error_log /var/log/nginx/staging-error.log;

    location / {
        proxy_pass http://127.0.0.1:5002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Staging-specific headers
    add_header X-Environment "staging" always;
    add_header X-TechCorp-Version "2.1.4-staging" always;
    add_header X-Server-Type "staging-web-01" always;
}

# Admin subdomain - admin.techcorp.local
server {
    listen 8083;
    server_name admin.techcorp.local;

    # Logging
    access_log /var/log/nginx/admin-access.log;
    error_log /var/log/nginx/admin-error.log;

    location / {
        proxy_pass http://127.0.0.1:5003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Important: Pass Authorization header for HTTP Basic Auth
        proxy_set_header Authorization $http_authorization;
        proxy_pass_header Authorization;
    }

    # Admin portal headers
    add_header X-Portal-Type "admin" always;
    add_header X-Auth-Method "basic" always;
    add_header X-TechCorp-Version "2.1.4" always;
}

# Catch-all for subdomain enumeration/fuzzing
# This will respond to any subdomain not explicitly configured above
server {
    listen 8080 default_server;
    server_name _;

    return 404 "Subdomain not found. Try enumerating other subdomains!\n";
}

# Optional: HTTP to HTTPS redirect (if using SSL in future)
# Commented out for lab simplicity
# server {
#     listen 80;
#     server_name techcorp.local dev.techcorp.local staging.techcorp.local admin.techcorp.local;
#     return 301 https://$server_name$request_uri;
# }
